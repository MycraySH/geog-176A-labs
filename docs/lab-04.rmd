---
title: "Geography 176A"
author: "[Stone Shi](https://mycraysh.github.io/StoneGIS/)"
subtitle: 'Lab 04: Tesselations, Point-in-Polygon'
output:
  html_document:
    theme: journal
---
```{r library,include=FALSE}
library(tidyverse)
library(knitr)
library(USAboundaries)
library(sf)
library(units)
library(rmapshaper)
library(readxl)
library(ggplot2)
library(leaflet)
library(leafpop)
library(plotrix)
library(gghighlight)
```

#Question 1

#1.1
```{r,message=FALSE, warning=FALSE}
mapdata = USAboundaries::us_counties() %>%
  filter(!state_name %in% c("Puerto Rico", "Alaska", "Hawaii")) %>%
  st_transform(5070)
mapnpts = mapview::npts(mapdata)
mapdel = ms_simplify(mapdata, keep = 0.05)
delnpts = mapview::npts(mapdel)

```

#1.2
```{r,message=FALSE, warning=FALSE}
counties_cent = st_centroid(mapdata) %>% 
  st_combine() %>%
  st_cast("MULTIPOINT")
```

#1.3
```{r,message=FALSE, warning=FALSE}
countiesun = st_union(counties_cent)

ct_voroni = st_voronoi(counties_cent) %>%
  st_cast() %>%
  st_as_sf %>%
  mutate(id=1:n())

ct_trian = st_triangulate(counties_cent) %>%
  st_cast() %>%
  st_as_sf() %>%
  mutate(id=1:n())

ct_grid_cv =st_make_grid(mapdata, n = c(70, 50)) %>%
  st_cast() %>%
  st_as_sf() %>%
  mutate(id = 1:n())

ct_hexagon_cv =  st_make_grid(mapdata, n = c(70, 50), square = FALSE) %>%
  st_cast() %>%
  st_as_sf() %>%
  mutate(id = 1:n())

```


#1.4 - 1.5
```{r,message=FALSE, warning=FALSE}
ct_voroni= st_intersection(ct_voroni, st_union(mapdel))
ct_trian = st_intersection(ct_trian, st_union(mapdel))
ct_grid_cv = st_intersection(ct_grid_cv, st_union(mapdel))
ct_hexagon_cv = st_intersection(ct_hexagon_cv, st_union(mapdel))
```

#1.6
```{r,message=FALSE, warning=FALSE}
plot_tess = function(data, title)
  {
  ggplot() + 
    geom_sf(data = data, fill = "white", col = "navy", size = .2)+
    theme_void()+
    labs(title = title, caption = paste("This tesselation has:", nrow(data), "tiles" )) +
    theme(plot.title = element_text(hjust = .5, color =  "navy"))
}

plot_tess(data = mapdel, "Original Data of the Counties")

plot_tess(data =ct_voroni, "Voroni Data of the Counties") +
   geom_sf(data = counties_cent, col = "darkred", size = .2)

plot_tess(data =ct_trian, "Trianangle Data of the Counties") +
   geom_sf(data = counties_cent, col = "darkred", size = .2)


plot_tess(data =ct_grid_cv, "Square Coverage of the Counties")


plot_tess(data =ct_hexagon_cv, "Hexagonal Coverage of the Counties")
```
#Question 2
#2.1-2.2
```{r,message=FALSE, warning=FALSE}
tessellation = function(data, title) 
  {area = st_area(data) %>% 
    units::set_units("km2") %>%
    units::drop_units() 
  data_frame(title, nrow(data), mean(area), sd(area), sum(area)) }

#2.3
tess_summary = bind_rows(
   tessellation(mapdel, "Counties"),
   tessellation(ct_voroni, "Voroni"),
   tessellation(ct_trian, "Triangulation"),
   tessellation(ct_grid_cv, "Grid"),
   tessellation(ct_hexagon_cv, "Hexagon"))

#2.4
knitr::kable(tess_summary,
caption = "Tessellation Characteristics",
col.names = c("Type","Numbers","Mean Area/km^2","Std Deviation Area/km^2","Covered Area/km^2"),
format.args = list(big.mark = ","))

#2.5
#Different tessellation methods may obtain different data during calculation.
#County tessellation is the most standard method, which provides accurate information for the programmer.
#The Voroni tessellation is more detailed and varied when slicing the areas surrounding the center of the map.Based on its calculation method, the Voroni tessellation can effectively analyze the regional density.
#The triangle tessellation divide the map data into several triangles.
#Both Grid and Hexagon tessellations divide surfaces into areas of equal area, which increase accuracy in calculating data relative to "per capita".
#In the region of quadrilateral subdivision, only the x and y coordinates need to be specified, which means it can be used widely.
#In these four tessellations, the hexagon tessellation can cover the most accurate surface area.
```

#Question 3

#3.1
```{r,message=FALSE, warning=FALSE}
NID = read_excel('D:/LifeInUCSB/Study/GEOG176A/week2/assignment5/geog-176A-labs/data/NID2019.xlsx') %>% 
  filter(!is.na(LONGITUDE)) %>% 
  filter(!is.na(LATITUDE))

stDAM <- NID %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326) %>%
  st_transform(5070) 
```

#3.2
```{r,message=FALSE, warning=FALSE}
point_in_polygon = function(points, polygon, id)
  {st_join(polygon, points) %>%
    st_drop_geometry() %>%
    dplyr::count(.data[[id]]) %>%
    setNames(c(id, "n")) %>%
    left_join(polygon, by = id) %>%
    st_as_sf()
    }
```

#3.3
```{r,message=FALSE, warning=FALSE}
oripol = point_in_polygon(stDAM, mapdel,"geoid")
vorpol = point_in_polygon(stDAM, ct_voroni,"id")
trianpol = point_in_polygon(stDAM,ct_trian,"id")
gridpol = point_in_polygon(stDAM,ct_grid_cv,"id")
hexpol = point_in_polygon(stDAM,ct_hexagon_cv,"id")
```
#3.4
```{r,message=FALSE, warning=FALSE}
plot_in_polygon2 = function(data, title)
  {ggplot() +
    geom_sf(data = data, aes(fill = log(n)), alpha = 1, size = .2, col = NA) +
    scale_fill_viridis_c()+
    theme_dark()+
    theme(legend.position = 'none',
          plot.title = element_text(face = "bold", color = "black", size = 20,hjust = .5)) +
    labs(title = title,
         caption = paste0(sum(data$n), "Number of Dams"))}
```

#3.5
```{r,message=FALSE, warning=FALSE}
plot_in_polygon2(oripol, "Number of Dams In Countries")
plot_in_polygon2(vorpol, "Number of Dams by Voroni Pattern")
plot_in_polygon2(trianpol, "Number of Dams by Triangle Pattern")
plot_in_polygon2(gridpol, "Number of Dams by Grid Pattern")
plot_in_polygon2(hexpol, "Number of Dams by Hexagon Pattern")

#3.6
#The influence of the hegagon tessellated surface in the visualization of point counts
#
```
#Question 4

#4.1-4.2
```{r,message=FALSE, warning=FALSE}
#The diagram of dams usage


#Irragation(I)
irrigation <- stDAM %>% 
  filter(grepl("I", stDAM$PURPOSES)==TRUE)
irripol = point_in_polygon(irrigation,ct_voroni,"id")
plot_in_polygon2(irripol, "Areas which dams are likely used for irrigation") +
  gghighlight::gghighlight(n > mean(n) + 1) 

#Navigation
navigation <- stDAM %>% 
  filter(grepl("N", stDAM$PURPOSES)==TRUE)
navipol = point_in_polygon(navigation,ct_voroni,"id")
plot_in_polygon2(navipol, "Areas which dams are likely used for navigation") +
  gghighlight::gghighlight(n > mean(n) + 1) 

#Water Supply
water <- stDAM %>% 
  filter(grepl("S", stDAM$PURPOSES)==TRUE)
watpol = point_in_polygon(water,ct_voroni,"id")
plot_in_polygon2(watpol,"Areas which dams are likely used for water supply") +
  gghighlight::gghighlight(n > mean(n) + 1) 
#Recreation
recreation <- stDAM %>% 
  filter(grepl("R", stDAM$PURPOSES)==TRUE)
recpol = point_in_polygon(recreation,ct_voroni,"id")
plot_in_polygon2(recpol, "Areas which dams are likely used for recreation") +
  gghighlight::gghighlight(n > mean(n) + 1) 
```

#4.3
```{r, warning = FALSE, message = FALSE}
#The geographical distribution of dams used in different fields has its significance.
#
```

# Extra credit
```{r message=FALSE, warning=FALSE}
missi = read_sf('D:/LifeInUCSB/Study/GEOG176A/week2/assignment5/geog-176A-labs/data/MajorRivers/MajorRivers.shp')
missi = missi %>% 
  filter(SYSTEM == "Mississippi")

stDAMbig = stDAM %>%
  filter(HAZARD == "H", grepl("C", PURPOSES)) %>%
  group_by(STATE) %>%
  slice_max(NID_STORAGE) %>%
  select("DAM_NAME", "NID_STORAGE", "PURPOSES", "YEAR_COMPLETED")

big_dam = st_transform(stDAMbig, 4326)
pop_dam = leafpop::popupTable(st_drop_geometry(stDAMbig), feature.id = FALSE, row.numbers = FALSE)
leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolylines(data = missi) %>%
  addCircleMarkers(data = big_dam,radius = ~NID_STORAGE / 1500000, color = "red",stroke = FALSE,fillOpacity = 1, popup = ~pop_dam)
```
