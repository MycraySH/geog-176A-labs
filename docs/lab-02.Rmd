---
title: "Geography 176A"
author: "[Stone Shi](https://mycraysh.github.io/StoneGIS/)"
subtitle: 'Lab 03: COVID-19 Pandemic'
output:
  html_document:
    theme: journal
---
#libraries
```{r library,include=FALSE}
library(tidyverse)
library(knitr)
library(zoo)
library(readxl)
covid = read_csv("D:/LifeInUCSB/Study/GEOG176A/week2/assignment5/geog-176A-labs/data/covid.csv")
pop <- read_excel("D:/LifeInUCSB/Study/GEOG176A/week2/assignment5/geog-176A-labs/data/PopulationEstimates.xls", skip = 2)
```
#Calculating the new cases in each county
```{r,message=FALSE, warning=FALSE}
casedata = covid %>%
  filter(state == "California") %>%
  group_by(county) %>% 
  mutate(Ncases = cases - lag(cases)) %>% #calculate the new cases
  ungroup()

Nday = casedata %>% #find the most recent date
  filter(date == max(date))
```
#Cumulative cases in the 5 worst counties
``` {r, message = FALSE, warning = FALSE}
mcumulcases = casedata %>%
  filter(date == max(date)) %>%
  select(county, cases) %>% 
  slice_max(cases, n = 5)

knitr::kable(mcumulcases, 
             caption = "Most cumulative cases in california counties",
             col.names = c("County", "Cumulative Cases"),
             format.args = list(big.mark = ","))
``` 
#New cases in the 5 worst counties
``` {r, message = FALSE, warning = FALSE}
mnewcases = Nday %>%
  select(county, Ncases) %>% 
  slice_max(Ncases, n = 5)

knitr::kable(mnewcases, 
             caption = "Most new cases in California counties",
             col.names = c("County", "New Cases"),
             format.args = list(big.mark = ","))
```
#Update case data based on population data
```{r message=FALSE, warning=FALSE}
pop_capita = pop %>%
  select(fips = "FIPStxt",newpop ="POP_ESTIMATE_2019",state = "State") %>%
  right_join(casedata, by = "fips") %>%
  mutate(cumul_cases_pcapita = (cases/newpop), new_cases_pcapita = (Ncases/newpop))

```
#The most cumulative cases per capita
```{r, message = FALSE, warning = FALSE}
cumul_capita = pop_capita %>%
    filter(date == max(date)) %>%
    slice_max(cases, n = 5) %>%
    select(county, cumul_cases_pcapita)

knitr::kable(cumul_capita,
             caption = "The most cumulative cases per capita in California Counties", 
             col.names = c("County", "Cumulative cases per capita"), 
             format.args = list(big.mark = ",")) 
```
#The most New cases per capita
```{r, message = FALSE, warning = FALSE}
new_capita = pop_capita %>%
    filter(date == max(date)) %>%
    slice_max(cases, n = 5) %>%
    select(county, new_cases_pcapita)

knitr::kable(new_capita,
             caption = "The most new cases per capita in California Counties", 
             col.names = c("County", "New cases per capita"), 
             format.args = list(big.mark = ","))
```
#recent 14 days data
```{r, message = FALSE, warning = FALSE}
covid_pcap = right_join(pop_capita, casedata, by = "fips") %>% 
  (recent14= covid_pcap %>%
  filter(date >= max(date) - 13) %>%
  select(county = county.y, Ncases, newpop, date) %>%
  group_by(county, newpop) %>%
  summarise(Ncases14 = sum(Ncases, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(cumul_milion = (newpop/100000), new_milion = (newpop/cumul_milion)))
```
#Safe Counties
```{r, message = FALSE, warning = FALSE}
safecounties = pop_capita %>%
  group_by(county, newpop) %>%
  summarise(totalnew = sum(Ncases, na.rm = TRUE)) %>% 
  mutate(safecountiesname = totalnew/(newpop/100000)) %>% 
  filter(safecountiesname < 100)
```
##results 
The total number of cases in California is `r sum(Nday$cases)`, which `r sum(Nday$Ncases)` of the population are new cases. California has `r nrow(safecounties)` safe counties. 

##Question 2
```{r, message = FALSE, warning = FALSE}

covid2 = covid %>%
  filter(state %in% c("California", "New York", "Louisiana", "Florida")) %>%
  group_by(state, date) %>%
  summarise(cases = sum(cases, na.rn = TRUE)) %>%
  mutate(NScases = cases - lag(cases), averagedaily = rollmean(NScases, 7, fill = NA, align = "right")) %>%
  ungroup() %>%
  filter(NScases >= 0)
```
#State level new cases
```{r, message = FALSE, warning = FALSE}
covid2 %>% 
  ggplot(aes(x = as.Date(date))) +
  geom_col(aes(y = NScases, col = state)) +
  geom_line(aes(y = averagedaily), size = 1, col = "purple") +
  facet_wrap(~state, scales = 'free_y') +
  labs(title = "State level New COVID Cases",
       x = "",
       y = "",
       caption = "NY Times COVID Data",
       subtitle = "7-day Average") +
  theme_dark() +
  theme(legend.position = "NA")
```
#State level new cases per capita
```{r, message = FALSE, warning = FALSE}
covid2  %>% 
  ggplot(aes(x = date)) +
  geom_col(aes(y = new_states_cases, col = state)) +
  geom_line(aes(y = dailymean), size = 1, col = "blue") +
  facet_wrap(~state, scales = 'free_y') +
  labs(title = "New COVID Cases by State",
       x = "",
       y = "",
       caption = "NY Times COVID Data",
       subtitle = "7-day Average (Blue)") +
  theme_dark() +
  theme(legend.position = "NA") ->
  lab2plot
ggsave(lab2plot, file = "lab2plot.png",
       width = 8,
       unit = "in")
